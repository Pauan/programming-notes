.Task.nu
[source]
----
(TYPE (Task Value))

(TYPE (Thread Value))

(EXPORT { error
          cancel
          never
          finally = _finally
          on-cancel = on_cancel
          w/resource
          execute
          ignore
          # TODO get rid of all thread stuff ?
          thread
          thread/wait = thread_wait
          thread/kill! = thread_kill
          concurrent
          race
          delay
          log }

  (FFI-IMPORT "Task"
    (run_root :: (-> (-> (Task Void)) Void))

    (success :: (FORALL A
                  (-> A (Task A))))

    (error :: (FORALL A
                (-> String (Task A))))

    (cancel :: (FORALL A
                 (-> (Task A))))

    (never :: (FORALL A
                (-> (Task A))))

    (_bind :: (FORALL A B
                (-> (Task A)
                    (-> A (Task B))
                    (Task B))))

    (with_resource :: (FORALL A B
                        (-> (Task A)
                            (-> A (Task B))
                            (-> A (Task Void))
                            (Task B))))

    (_finally :: (FORALL A
                   (-> (Task A)
                       (Task Void)
                       (Task A))))

    (on_cancel :: (FORALL A
                    (-> (Task A)
                        (Task A)
                        (Task A))))

    (execute :: (FORALL A
                  (-> (-> A) (Task A))))

    (ignore :: (FORALL A
                 (-> (Task A)
                     (Task Void))))

    (thread :: (FORALL A
                 (-> (Task A) (Thread A))))

    (thread_wait :: (FORALL A
                      (-> (Thread A) (Task A))))

    (thread_kill :: (FORALL A
                      (-> (Thread A) (Task Void))))

    (concurrent :: (FORALL A
                     (-> @(Task A) (Task (List A)))))

    (race :: (FORALL A
               (-> @(Task A) (Task A))))

    (delay :: (-> Integer (Task Void)))

    (log :: (-> String (Task Void))))

  # TODO is there a better way of handling this ?
  (MACRO
    (FFI-PROGRAM-START)
      `(run_root ,(symbol "main")))

  (MACRO
    (w/resource `(,name = ,before) during after)
      `(with_resource ,before
         (-> ,name ,during)
         (-> ,name ,after)))

  (IMPLEMENT Task
    (wrap x)
      (success x)

    (bind x f)
      (_bind x f)))

(FUNCTION
  (forever :: (FORALL A
                (-> (Task Void) (Task A))))
  (forever task)
    (DO task
        (forever task)))

(FUNCTION
  (timeout :: (FORALL A
                (-> Integer (Task Void) (Task Void))))
  (timeout ms task)
    (race task (delay ms)))

(FUNCTION
  (ignore-concurrent :: (FORALL A
                          (-> @(Task A) (Task Void))))
  (ignore-concurrent @in)
    (ignore (concurrent @in)))

(FUNCTION
  (ignore-thread :: (FORALL A
                      (-> (Task A) (Task Void))))
  (ignore-thread task)
    (ignore (thread task)))
----
